"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])};return function(e,a){function i(){this.constructor=e}t(e,a),e.prototype=null===a?Object.create(a):(i.prototype=a.prototype,new i)}}(),powerbi;!function(t){var e;!function(t){var e;!function(e){function a(e,a,i,n){void 0===n&&(n=0);var r,s,o,l=.8/.9*1.025;if(n){var h=n,d=a.labelRadius;s=[Math.cos(h)*d,Math.sin(h)*d],o=[Math.cos(h)*d,Math.sin(h)*d]}else s=a.labelArc.centroid(e),o=a.labelArc.centroid(e);var c=i.x,u=t.LabelUtils.maxLabelOffset/2;return c+=c<0?-u:u,r=[c,i.y],o[0]*=l,o[1]*=l,[o,s,r]}function i(e){if(e&&e.length>2){return[{width:Math.abs(e[1][0]-e[0][0]),height:Math.abs(e[1][1]-e[0][1])},{width:Math.abs(e[2][0]-e[1][0]),height:t.NewDataLabelUtils.LineStrokeWidth}]}return null}function n(e){return e+=e<0?-t.LabelUtils.maxLabelOffset:t.LabelUtils.maxLabelOffset}function r(e,a){return a.width/2-Math.abs(e)-t.LabelUtils.maxLabelOffset}function s(t,e){var a,i;return i=e*Math.sin(t-Math.PI/2),a=e*Math.cos(t-Math.PI/2),{x:a,y:i}}function o(t,e,a){for(var i=a.left,n=a.left+a.width,r=a.top,s=a.top+a.height,o=[{x:i,y:r},{x:i,y:s},{x:n,y:r},{x:n,y:s}],h=0,d=o;h<d.length;h++){if(!l(t,e,d[h]))return!1}return!0}function l(t,e,a){var i=Math.sqrt(a.x*a.x+a.y*a.y);if(i<e.innerRadius)return!1;if(i>e.outerRadius)return!1;var n=h(a);return!(n<t.startAngle)&&!(n>t.endAngle)}function h(t){if(t){var e=t.x,a=-t.y,i=Math.atan2(e,a);return i<0&&(i+=2*Math.PI),i}}e.DiagonalLineIndex=0,e.HorizontalLineIndex=1,e.getLabelLeaderLineForDonutChart=a,e.getLabelLeaderLinesSizeForDonutChart=i,e.getXPositionForDonutLabel=n,e.getSpaceAvailableForDonutLabels=r,e.getLabelPosition=s,e.canLabelFit=o,e.canPointFit=l,e.getAngleFromPoint=h}(e=t.DonutLabelUtils||(t.DonutLabelUtils={}))}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e;!function(e){var a,i=jsCommon.CssConstants.createClassAndSelector,n=jsCommon.EnumExtensions,r=e.labelStyle.labelStyleFlagEnum,s=e.labelStyle;!function(t){t.animationDurationMs=500,t.ease="cubic-in-out"}(a||(a={}));var o="donutChart",l="donutLegend",h="donutLegendArrow",d=.9,c=1,u=.6,g=1,p=72,v=i("slice"),f=i("slice-highlight"),y=2*Math.PI;e.DefaultDonutStrokeColorName="foregroundLight";var b=function(){function i(t){t&&(this.isDonutChart=0!==t.sliceWidthRatio,this.animator=t.animator,this.isScrollable=!!t.isScrollable&&t.isScrollable,this.disableGeometricCulling=!!t.disableGeometricCulling&&t.disableGeometricCulling,this.behavior=t.behavior,this.tooltipsEnabled=t.tooltipsEnabled,t.smallViewPortProperties&&(this.maxHeightToScaleDonutLegend=t.smallViewPortProperties.maxHeightToScaleDonutLegend))}return i.getDefaultDonutLabelSettings=function(t){var a=i.getDefaultLabelSettings(t);return a.labelStyle=s.category,a.percentagePrecision=e.dataLabelUtils.defaultPercentageLabelPrecision,a.position=e.donutLabelPosition.outside,a.overflow=!0,a.enableBackgroundWithAuto=e.donutLabelBackground.auto,a},i.converter=function(t,e,a,n,r,s,o){void 0===o&&(o=!0);var l=new m.DonutChartConverter(t,e,a,o);l.convert();var h=d3.layout.pie().sort(null).value(function(t){return t.percentage});s&&(s.applySelectionStateToData(l.dataPoints),s.applySelectionStateToData(l.legendData.dataPoints));var d=e.isHighContrast||r||!n?l.dataPoints:i.cullDataByViewport(l.dataPoints,l.maxValue,n);return{dataPointsToDeprecate:d,dataPoints:h(d),unCulledDataPoints:l.dataPoints,dataPointsToEnumerate:l.legendData.dataPoints,legendData:l.legendData,hasHighlights:l.hasHighlights,highlightsOverflow:l.highlightsOverflow,dataLabelsSettings:l.dataLabelsSettings,legendObjectProperties:l.legendObjectProperties,maxValue:l.maxValue,visibleGeometryCulled:l.dataPoints.length!==d.length,hasNegativeValues:l.hasNegativeValues,allValuesAreNegative:l.allValuesAreNegative,donutInnerRadiusRatio:l.donutInnerRadiusRatio}},i.prototype.init=function(t){this.options=t;var a=t.element;a.empty(),this.parentViewport=t.viewport,this.currentViewport={height:t.viewport.height,width:t.viewport.width},this.style=t.style,this.colors=this.style.colorPalette.dataColors;var n=e.Legend.getDefaultLegendData(this.style);if(this.data={dataPointsToDeprecate:[],dataPointsToEnumerate:[],dataPoints:[],unCulledDataPoints:[],legendData:n,hasHighlights:!1,highlightsOverflow:!1,dataLabelsSettings:i.getDefaultDonutLabelSettings(this.style),hasNegativeValues:!1,allValuesAreNegative:!1,donutInnerRadiusRatio:this.isDonutChart?i.DefaultDonutInnerRadiusRatio:0},this.radius=0,this.mobileInteractiveLegend=t.interactivity&&t.interactivity.isInteractiveLegend,this.behavior&&(this.interactivityService=e.createInteractivityService(t.host)),this.legend=e.createLegend(a,t.interactivity&&t.interactivity.isInteractiveLegend,this.interactivityService,this.isScrollable,void 0,this.style),this.hostService=t.host,this.tooltipService=e.createTooltipService(t.host),this.mobileInteractiveLegend){var r=this.legendContainer=d3.select(a.get(0)).append("div").classed(l,!0);this.interactivityState={interactiveLegend:new L(this,r,this.colors,t),valueToAngleFactor:0,sliceAngles:[],currentRotate:0,interactiveChosenSliceFinishedSetting:!1,lastChosenInteractiveSliceIndex:0,totalDragAngleDifference:0,currentIndexDrag:0,previousIndexDrag:0,previousDragAngle:0,donutCenter:{x:0,y:0}}}this.svg=d3.select(a.get(0)).append("svg").style("position","absolute").classed(o,!0),this.behavior&&(this.clearCatcher=e.appendClearCatcher(this.svg)),this.mainGraphicsContext=this.svg.append("g"),this.mainGraphicsContext.append("g").classed("slices",!0),this.labelBackgroundGraphicsContext=this.svg.append("g").classed(e.LabelUtils.labelBackgroundGraphicsContextClass.class,!0),this.labelGraphicsContext=this.svg.append("g").classed(e.LabelUtils.labelGraphicsContextClass.class,!0),this.pie=d3.layout.pie().sort(null).value(function(t){return t.percentage})},i.prototype.update=function(a){var n=a.viewport;this.parentViewport=n;var r=this.dataViews,s=a.type===t.VisualUpdateType.Resize||a.type===t.VisualUpdateType.ResizeEnd;if(s||(r=this.dataViews=a.dataViews,r&&r.length>0&&r[0].categorical?this.data=i.converter(r[0],this.style,this.isDonutChart,this.parentViewport,this.disableGeometricCulling,this.interactivityService,this.tooltipsEnabled):this.data={dataPointsToDeprecate:[],dataPointsToEnumerate:[],dataPoints:[],unCulledDataPoints:[],legendData:e.Legend.getDefaultLegendData(this.style),hasHighlights:!1,highlightsOverflow:!1,dataLabelsSettings:i.getDefaultDonutLabelSettings(this.style),hasNegativeValues:!1,allValuesAreNegative:!1,donutInnerRadiusRatio:this.isDonutChart?i.DefaultDonutInnerRadiusRatio:0}),this.options.interactivity&&this.options.interactivity.isInteractiveLegend||this.renderLegend(!s||a.isInFocus),this.initViewportDependantProperties(),this.initDonutProperties(),this.updateInternal(this.data,a.suppressAnimations),r){var o=e.getInvalidValueWarnings(r,!1,!1,!1,["Tooltips"]);this.data.allValuesAreNegative?o.push(new e.AllNegativeValuesWarning):this.data.hasNegativeValues&&o.push(new e.NegativeValuesNotSupportedWarning),this.hostService.setWarnings(o)}},i.prototype.enumerateObjectInstances=function(t){var a=new e.ObjectEnumerationBuilder,n=this.data&&this.data.dataLabelsSettings?this.data.dataLabelsSettings:i.getDefaultDonutLabelSettings(this.style);switch(t.objectName){case"legend":this.enumerateLegend(a);break;case"dataPoint":this.enumerateDataPoints(a);break;case"slices":this.enumerateSlices(a);break;case"labels":var r={enumeration:a,dataLabelsSettings:n,show:!0,displayUnits:!0,precision:!0,percentagePrecision:!0,fontSize:!0,fontFamily:!0,labelStyle:!0,style:this.style},s=void 0;s={position:n.position},n.position!==e.donutLabelPosition.outside&&(s.overflow=n.overflow,s.background=n.enableBackgroundWithAuto),e.LabelUtils.enumerateDataLabels(r,s)}return a.complete()},i.prototype.enumerateDataPoints=function(a){this.data&&t.requireSync("PowerBIVisuals/Visuals/common/colorEnumerationHelper").enumerateSeriesDataColors({enumeration:a,dataPoints:e.LegendData.toIEnumerableDataPoints(this.data.legendData)})},i.prototype.enumerateLegend=function(t){if(this.data){var a=this.data.legendData;e.Legend.enumerate({enumeration:t,legendData:a})}},i.prototype.enumerateSlices=function(t){if(this.data&&this.isDonutChart){var e={selector:null,properties:{innerRadiusRatio:Math.round(100*this.data.donutInnerRadiusRatio/i.OuterRadiusRatio)},objectName:"slices"};t.pushInstance(e)}},i.prototype.setInteractiveChosenSlice=function(t){var i=this;if(0!==this.interactivityState.sliceAngles.length){this.interactivityState.lastChosenInteractiveSliceIndex=t,this.interactivityState.interactiveChosenSliceFinishedSetting=!1;var n=this.currentViewport,r=t%this.data.dataPoints.length,s=this.interactivityState.sliceAngles[r];this.svg.select("g").transition().duration(a.animationDurationMs).ease(a.ease).attr("transform",e.SVGUtil.translateAndRotate(n.width/2,n.height/2,0,0,s)).each("end",function(){i.interactivityState.interactiveChosenSliceFinishedSetting=!0}),this.interactivityState.currentRotate=s,this.interactivityState.interactiveLegend.updateLegend(r),this.svg.selectAll(".slice").attr("opacity",function(t,e){return e===r?1:.6}),e.SVGUtil.flushAllD3TransitionsIfNeeded(this.options)}},i.prototype.calculateRadius=function(){var t=this.currentViewport;if(!this.mobileInteractiveLegend&&this.data&&this.data.dataLabelsSettings.show){var e=t.height/t.width,a=2+1/(1+Math.exp(-5*(e-1)));return Math.min(t.height,t.width)/a}return Math.min(t.height,t.width)/2},i.prototype.getScaleForLegendArrow=function(){var t=1;return this.maxHeightToScaleDonutLegend&&this.currentViewport.height<this.maxHeightToScaleDonutLegend&&(t=this.currentViewport.height/this.maxHeightToScaleDonutLegend),t},i.prototype.initViewportDependantProperties=function(t){void 0===t&&(t=0),this.currentViewport.height=this.parentViewport.height,this.currentViewport.width=this.parentViewport.width;var a=this.currentViewport;if(this.mobileInteractiveLegend)a.height-=i.InteractiveLegendContainerHeight;else{var n=this.legend.getMargins();a.height-=n.height,a.width-=n.width}this.svg.attr({width:a.width,height:a.height}),this.mobileInteractiveLegend?(this.legendContainer.style({width:"100%",height:i.InteractiveLegendContainerHeight+"px",overflow:"hidden",top:0}),this.svg.style("top",i.InteractiveLegendContainerHeight)):e.Legend.positionChartArea(this.svg,this.legend),this.previousRadius=this.radius;var r=this.radius=this.calculateRadius(),s=a.width/2,o=a.height/2;this.outerArc=d3.svg.arc(),this.labelArc=d3.svg.arc().innerRadius(r*d).outerRadius(r*d),this.mobileInteractiveLegend?(this.mainGraphicsContext.attr("transform",e.SVGUtil.translate(s,o)),this.labelGraphicsContext.attr("transform",e.SVGUtil.translate(s,o)),this.labelBackgroundGraphicsContext.attr("transform",e.SVGUtil.translate(s,o))):(this.mainGraphicsContext.transition().duration(t).attr("transform",e.SVGUtil.translate(s,o)),this.labelGraphicsContext.transition().duration(t).attr("transform",e.SVGUtil.translate(s,o)),this.labelBackgroundGraphicsContext.transition().duration(t).attr("transform",e.SVGUtil.translate(s,o))),e.SVGUtil.flushAllD3TransitionsIfNeeded(this.options)},i.prototype.initDonutProperties=function(){this.donutProperties={viewport:this.currentViewport,outerArc:this.outerArc.innerRadius(0).outerRadius(this.radius*this.data.donutInnerRadiusRatio),labelArc:this.labelArc,dataLabelsSettings:this.data.dataLabelsSettings,innerRadius:this.radius*this.data.donutInnerRadiusRatio,outerRadius:this.radius*i.OuterRadiusRatio,labelRadius:this.radius*d}},i.prototype.mergeDatasets=function(e,a){var i=d3.set();a.forEach(function(t){i.add(t.identity?t.identity.getKey():t.data.identity.getKey())});var n=e.filter(function(t){return!i.has(t.identity?t.identity.getKey():t.data.identity.getKey())}).map(function(e){var a=t.Prototype.inherit(e);return void 0===a.percentage?a.data.percentage=0:a.percentage=0,a});return d3.merge([a,n])},i.prototype.updateInternal=function(t,a,n){void 0===n&&(n=0);var r=this.currentViewport;if(n=n||e.AnimatorCommon.GetAnimationDuration(this.animator,a),this.animator){var s,o=i.getLayout(this.donutProperties,this.style),l=void 0,h=void 0,d=t.dataLabelsSettings,c=[];if(d&&d.show&&(c=this.createLabels()),!a){var u={viewModel:t,colors:this.colors,graphicsContext:this.mainGraphicsContext,labelGraphicsContext:this.labelGraphicsContext,labelBackgroundContext:this.labelBackgroundGraphicsContext,interactivityService:this.interactivityService,layout:o,radius:this.radius,donutProperties:this.donutProperties,viewport:r,labels:c,style:this.style};l=this.animator.animate(u),s=l.shapes,h=l.highlightShapes}(a||l.failed)&&(s=i.drawDefaultShapes(this.svg,t,o,this.radius,this.interactivityService&&this.interactivityService.hasSelection(),this.style),h=i.drawDefaultHighlightShapes(this.svg,t,o,this.radius,this.style),e.NewDataLabelUtils.drawLabelsAndBackgrounds({labelContext:this.labelGraphicsContext,dataLabels:e.LabelUtils.downgradeToOldLabels(c),numeric:!1,backgroundContext:this.labelBackgroundGraphicsContext,twoRows:!0,hasTooltip:!0}),e.LabelUtils.drawLabelLeaderLines(this.labelGraphicsContext,c)),this.assignInteractions(s,h,t),this.tooltipsEnabled&&this.addTooltips(s,h)}else this.updateInternalToMove(t,n,this.style);e.SVGUtil.flushAllD3TransitionsIfNeeded(this.options)},i.prototype.createLabels=function(){var e=new t.DonutLabelLayout(this.donutProperties),a=this.createLabelDataPoints();return e.layout(a,this.data.dataLabelsSettings)},i.prototype.createLabelDataPoints=function(){var t=this.data,a=[],i=e.LabelUtils.createColumnFormatterCacheManager(),n=null;0===t.dataLabelsSettings.displayUnits&&(n=d3.max(t.dataPoints,function(t){return Math.abs(t.data.measure)}));for(var r=0;r<this.data.dataPoints.length;r++){var s=this.createLabelDataPoint(t.dataPoints[r],n,i);a.push(s)}return a},i.prototype.createLabelDataPoint=function(t,a,i){var s,o,l,h,d,c,u,g=this.labelArc.centroid(t),p=e.DonutLabelUtils.getXPositionForDonutLabel(g[0]),v=g[1],f=this.data.dataLabelsSettings,y=p<0?4:8,b={point:{x:p,y:v},validPositions:[y],radius:0},m=e.ColorHelper.getThemeColor(this.style,e.LabelUtils.DefaultLabelColorName),L=e.ColorHelper.getThemeColor(this.style,e.LabelUtils.DefaultInsideLabelColorName),S=f.fontProperties.color?f.fontProperties.color:m,C=f.fontProperties.color?f.fontProperties.color:L,P=e.LabelUtils.getLabelStyleFlagType(f.labelStyle),w=f?f.fontProperties:e.LabelUtils.defaultFontProperties,D="",x=this.data.hasHighlights,I=this.data.highlightsOverflow;if(n.hasFlag(P,e.labelStyle.flagLabelStyleData)){var A=void 0;A=x&&!I?t.data.originalHighlightValue:t.data.originalMeasure;var R=i.getOrCreate(t.data.labelFormatString,f,a);s=null!=A?R.format(A):null,o=e.LabelUtils.getTextSize(s,w)}if(n.hasFlag(P,e.labelStyle.flagLabelStyleCategory)&&(l=t.data.label,h=e.LabelUtils.getTextSize(l,w)),n.hasFlag(P,e.labelStyle.flagLabelStylePercent)){var k=e.valueFormatter.getLocalizedString("Percentage"),M=x&&!I?t.data.highlightPercentage:t.data.percentage,V=_.clone(f),F=V.percentagePrecision;if(V.displayUnits=0,_.isFinite(F)){var R=i.getOrCreate(k,V,null,V.percentagePrecision);d=null!=M?R.format(M):null}else d=e.valueFormatter.format(M,k);c=e.LabelUtils.getTextSize(d,w)}switch(P){case r.categoryAndDataAndPercent:D=l,s&&(D=D+" "+s),d&&(D=D+" ("+d+")"),u=e.LabelUtils.getTextSize(D,w);break;case r.categoryAndData:D=l,s&&(D=D+" "+s),u=e.LabelUtils.getTextSize(D,w);break;case r.categoryAndPercent:D=l,d&&(D=D+" "+d),u=e.LabelUtils.getTextSize(D,w);break;case r.dataAndPercent:D=s,d&&(D=D+" ("+d+")"),u=e.LabelUtils.getTextSize(D,w);break;case r.data:u=_.clone(o),D=s;break;case r.percent:u=_.clone(c),D=d;break;case r.category:u=_.clone(h),D=l;break;default:u=_.clone(h),D=l}var T=e.DonutLabelUtils.getLabelLeaderLineForDonutChart(t,this.donutProperties,b.point),O=e.DonutLabelUtils.getLabelLeaderLinesSizeForDonutChart(T);return{isPreferred:!0,text:"",tooltip:D,textSize:u,outsideFill:S,fontProperties:f.fontProperties,identity:t.data.identity,parentShape:b,insideFill:C,parentType:0,alternativeScale:a,donutArcDescriptor:t,angle:(t.endAngle+t.startAngle)/2,dataLabel:s,dataLabelSize:o,categoryLabel:l,categoryLabelSize:h,percentLabel:d,percentLabelSize:c,leaderLinePoints:T,linesSize:O,backgroundColor:f.backgroundColor,backgroundTransparency:f.backgroundTransparency}},i.prototype.renderLegend=function(t){if(!this.mobileInteractiveLegend){if(this.data.legendObjectProperties){var a=this.data.legendData;null!=a.position&&this.legend.changeOrientation(a.position),this.legend.drawLegend(a,this.parentViewport,t)}else this.legend.changeOrientation(e.LegendPosition.Top),this.legend.drawLegend(e.Legend.getDefaultLegendData(this.style),this.parentViewport,t)}},i.prototype.addInteractiveLegendArrow=function(){if(this.data&&this.data.dataPoints&&0!==this.data.dataPoints.length){var t=11,a=16.5;if(!this.interactiveLegendArrow){var i=this.svg.append("g");i.append("path").classed(h,!0).attr("d","M1.5,2.6C0.65,1.15,1.85,0,3,0l27,0c1.65,0,2.35,1.15,1.5,2.6L18,26.45c-0.8,1.45-2.15,1.45-2.95,0L1.95,2.6z"),this.interactiveLegendArrow=i}var n=this.currentViewport,r=this.getScaleForLegendArrow(),s=(n.height-2*this.radius)/2+t*r,o=n.width/2-a*r;this.interactiveLegendArrow.attr("transform",e.SVGUtil.translateAndScale(o,s,r))}},i.prototype.calculateSliceAngles=function(){var t=[],e=this.data.dataPoints;if(0===e.length)return this.interactivityState.valueToAngleFactor=0,void(this.interactivityState.sliceAngles=[]);for(var a=0,i=0,n=e.length;i<n;i++)a+=e[i].data.percentage;this.interactivityState.valueToAngleFactor=360/a;for(var r=0,i=0,n=e.length;i<n;i++){var s=e[i].data.percentage*this.interactivityState.valueToAngleFactor;r+=s,t.push(s/2-r)}this.interactivityState.sliceAngles=t},i.prototype.assignInteractions=function(t,e,a){if(this.mobileInteractiveLegend)this.assignInteractiveChartInteractions(t);else if(this.interactivityService){var i=a.dataPoints.map(function(t){return t.data}),n={clearCatcher:this.clearCatcher,slices:t,highlightSlices:e,visual:this,hasHighlights:a.hasHighlights};this.interactivityService.bind(i,this.behavior,n)}},i.prototype.assignInteractiveChartInteractions=function(t){var e=this,a=this.svg;this.interactivityState.interactiveChosenSliceFinishedSetting=!0;var i=a.node().getBoundingClientRect();this.interactivityState.donutCenter={x:i.left+i.width/2,y:i.top+i.height/2},this.interactivityState.totalDragAngleDifference=0,this.interactivityState.currentRotate=0,this.calculateSliceAngles(),t.on("click",function(t,a){d3.event.defaultPrevented||e.setInteractiveChosenSlice(a)});var n=d3.behavior.drag().origin(Object).on("dragstart",function(){return e.interactiveDragStart()}).on("drag",function(){return e.interactiveDragMove()}).on("dragend",function(){return e.interactiveDragEnd()});a.style("touch-action","none").call(n)},i.prototype.getAngleFromDragEvent=function(){var t,e,a=this.interactivityState,i=d3.event.sourceEvent;if(i.type.toLowerCase().indexOf("touch")!==-1){if(1!==i.touches.length)return null;var n=i.touches[0];t=n.pageX,e=n.pageY}else t=i.pageX,e=i.pageY;var r={x:t-a.donutCenter.x,y:-e+a.donutCenter.y};return 180*Math.atan2(r.y,r.x)/Math.PI},i.prototype.interactiveDragStart=function(){this.interactivityState.totalDragAngleDifference=0,this.interactivityState.previousDragAngle=this.getAngleFromDragEvent()},i.prototype.interactiveDragMove=function(){var t=this.data.dataPoints,a=this.currentViewport,i=this.interactivityState;if(i.interactiveChosenSliceFinishedSetting===!0){var n=this.getAngleFromDragEvent();if(!n)return;var r=i.previousDragAngle-n;i.totalDragAngleDifference+=r,i.previousDragAngle=n,i.currentRotate+=r,this.svg.select("g").attr("transform",e.SVGUtil.translateAndRotate(a.width/2,a.height/2,0,0,this.interactivityState.currentRotate));var s=t[0].data.percentage*i.valueToAngleFactor,o=i.currentRotate<=0?i.currentRotate*-1%360:360-i.currentRotate%360;i.currentIndexDrag=0;for(var l=t.length;i.currentIndexDrag<l&&o>s;)i.currentIndexDrag<l-1&&(s+=t[i.currentIndexDrag+1].data.percentage*i.valueToAngleFactor),i.currentIndexDrag++;i.currentIndexDrag!==i.previousIndexDrag&&(i.interactiveLegend.updateLegend(i.currentIndexDrag),this.svg.selectAll(".slice").attr("opacity",function(t,e){return e===i.currentIndexDrag?c:u}),i.previousIndexDrag=i.currentIndexDrag)}},i.prototype.interactiveDragEnd=function(){0!==this.interactivityState.totalDragAngleDifference&&(this.setInteractiveChosenSlice(this.interactivityState.currentIndexDrag),d3.event.sourceEvent.stopPropagation())},i.prototype.updateInternalToMove=function(t,a,n){void 0===a&&(a=0);var r=this.svg,s=this.pie,o=this.key,l=this.outerArc,h=this.radius,d=this.previousRadius,c=e.ColorHelper.getThemeColor(n,e.DefaultDonutStrokeColorName),u=this.donutProperties,g=this.svg.select(".slices").selectAll("path"+v.selector).data().map(function(t){return t.data});0===g.length&&(g=t.dataPointsToDeprecate);var p=this.mergeDatasets(g,t.dataPointsToDeprecate),y=r.select(".slices").selectAll("path"+v.selector).data(s(t.dataPointsToDeprecate),o);y.enter().insert("path").classed(v.class,!0).each(function(t){this._current=t}),y=r.select(".slices").selectAll("path"+v.selector).data(s(p),o);var b=this.donutProperties.innerRadius;if(i.isSingleColor(t.dataPoints),n.isHighContrast||y.style("stroke-opacity",function(a){return e.ColumnUtil.getFillOpacity(a.data.selected,!1,!1,t.hasHighlights)}).style("stroke-dasharray",function(t){return i.drawStrokeForDonutChart(t,u)}),y.style("fill",function(t){return t.data.color}).style("fill-opacity",function(a){return e.ColumnUtil.getFillOpacity(a.data.selected,!1,!1,t.hasHighlights)}).style("stroke",c).style("stroke-width",function(t){return t.data.strokeWidth}).transition().duration(a).attrTween("d",function(t){var e=d3.interpolate(this._current,t),a=d3.interpolate(d*i.OuterRadiusRatio,h*i.OuterRadiusRatio);return this._current=e(0),function(t){return l.innerRadius(b).outerRadius(a(t))(e(t))}}),y=r.select(".slices").selectAll("path"+v.selector).data(s(t.dataPointsToDeprecate),o),y.exit().transition().delay(a).duration(0).remove(),!this.mobileInteractiveLegend){var m=t.dataLabelsSettings,L=[];m&&m.show&&(L=this.createLabels()),e.NewDataLabelUtils.drawLabelsAndBackgrounds({labelContext:this.labelGraphicsContext,dataLabels:e.LabelUtils.downgradeToOldLabels(L),numeric:!1,backgroundContext:this.labelBackgroundGraphicsContext}),e.LabelUtils.drawLabelLeaderLines(this.labelGraphicsContext,L)}var S;t.hasHighlights?(S=r.select(".slices").selectAll("path"+f.selector).data(s(t.dataPointsToDeprecate),o),S.enter().insert("path").classed(f.class,!0).each(function(t){this._current=t}),i.isSingleColor(t.dataPoints),n.isHighContrast||S.style("stroke-opacity",1).style("stroke-dasharray",function(t){return i.drawStrokeForDonutChart(t,u,t.data.highlightRatio)}),S.style("fill",function(t){return t.data.color}).style("fill-opacity",1).style("stroke",c).style("stroke-width",function(t){return 0===t.data.highlightRatio?0:t.data.strokeWidth}).transition().duration(a).attrTween("d",function(t){var e=d3.interpolate(this._current,t),a=d3.interpolate(d*i.OuterRadiusRatio,i.getHighlightRadius(u,t.data.highlightRatio));return this._current=e(0),function(t){return l.innerRadius(b).outerRadius(a(t))(e(t))}}),S.exit().transition().delay(a).duration(0).remove()):r.selectAll("path"+f.selector).transition().delay(a).duration(0).remove(),this.assignInteractions(y,S,t),this.tooltipsEnabled&&this.addTooltips(y,S),e.SVGUtil.flushAllD3TransitionsIfNeeded(this.options),this.mobileInteractiveLegend&&(this.addInteractiveLegendArrow(),this.interactivityState.interactiveLegend.drawLegend(this.data.dataPointsToDeprecate),this.setInteractiveChosenSlice(this.interactivityState.lastChosenInteractiveSliceIndex?this.interactivityState.lastChosenInteractiveSliceIndex:0))},i.prototype.addTooltips=function(t,e){this.tooltipService.addTooltip(t,function(t){return t.data&&t.data.data.tooltipInfo},function(t){return t.data&&t.data.data.identity}),e&&this.tooltipService.addTooltip(e,function(t){return t.data&&t.data.data.tooltipInfo},function(t){return t.data&&t.data.data.identity})},i.drawDefaultShapes=function(t,a,n,r,s,o){var l=t.select(".slices").selectAll("path"+v.selector).data(a.dataPoints,function(t){return t.data.identity.getKey()});return l.enter().insert("path").classed(v.class,!0),i.isSingleColor(a.dataPoints),l.style("fill",function(t){return t.data.color}).style("fill-opacity",function(t){return e.ColumnUtil.getFillOpacity(t.data.selected,!1,s,a.hasHighlights)}).style("stroke-opacity",function(t){return e.ColumnUtil.getFillOpacity(t.data.selected,!1,s,a.hasHighlights)}).style("stroke",e.ColorHelper.getThemeColor(o,e.DefaultDonutStrokeColorName)).style("stroke-width",function(t){return t.data.strokeWidth}).attr(n.shapeLayout.attrs).style(n.shapeLayout.styles),l.exit().remove(),l},i.drawDefaultHighlightShapes=function(t,a,n,r,s){var o=t.select(".slices").selectAll("path"+f.selector).data(a.dataPoints.filter(function(t){return null!=t.data.highlightRatio}),function(t){return t.data.identity.getKey()});return o.enter().insert("path").classed(f.class,!0).each(function(t){this._current=t}),i.isSingleColor(a.dataPoints),o.style("fill",function(t){return t.data.color}).style("fill-opacity",function(t){return e.ColumnUtil.getFillOpacity(t.data.selected,!0,!1,a.hasHighlights)}).style("stroke-opacity",function(t){return e.ColumnUtil.getFillOpacity(t.data.selected,!0,!1,a.hasHighlights)}).style("stroke",e.ColorHelper.getThemeColor(s,e.DefaultDonutStrokeColorName)).style("stroke-width",function(t){return 0===t.data.highlightRatio?0:t.data.strokeWidth}).attr(n.highlightShapeLayout.attrs).style(n.highlightShapeLayout.styles),o.exit().remove(),o},i.isSingleColor=function(t){if(t.length>1){var e=t.length-1;t[e].data.isLastInDonut=t[e].data.color===t[0].data.color}},i.drawStrokeForDonutChart=function(t,e,a){void 0===a&&(a=1);var i,n,r=e.outerRadius*a,s=(t.endAngle-t.startAngle)*r,o=e.innerRadius;if(o>0){var l=e.outerRadius-o,h=(t.endAngle-t.startAngle)*o;if(t.data.highlightRatio&&(s=(t.endAngle-t.startAngle)*(l+o)),t.data.isLastInDonut)return"0 "+s+" "+l+" "+h+" "+l;i=s+l+h,n=l}else t.data.isLastInDonut?(i=s,n=2*r):(i=s+r,n=r);return"0 "+i+" "+n},i.prototype.onClearSelection=function(){this.interactivityService&&this.interactivityService.clearSelection()},i.prototype.onRestoreSelection=function(t){return!!this.interactivityService&&this.interactivityService.restoreSelection(t.selection)},i.getLayout=function(t,e){var a=t.innerRadius,n=t.outerRadius,r=a||i.EffectiveZeroValue,s=d3.svg.arc().innerRadius(a),o=d3.svg.arc().innerRadius(a).outerRadius(n),l=d3.svg.arc().innerRadius(a).outerRadius(r);return{shapeLayout:{attrs:{d:function(t){return o(t)}},styles:{"stroke-dasharray":e.isHighContrast?void 0:function(e){return i.drawStrokeForDonutChart(e,t)}}},highlightShapeLayout:{attrs:{d:function(e){return s.outerRadius(i.getHighlightRadius(t,e.data.highlightRatio))(e)}},styles:{"stroke-dasharray":e.isHighContrast?void 0:function(e){return i.drawStrokeForDonutChart(e,t,e.data.highlightRatio)}}},zeroShapeLayout:{attrs:{d:function(t){return l(t)}},styles:{"stroke-dasharray":e.isHighContrast?void 0:function(e){return i.drawStrokeForDonutChart(e,t,r)}}}}},i.getHighlightRadius=function(t,e){var a=t.innerRadius;return a+e*(t.outerRadius-a)},i.cullDataByViewport=function(t,e,a){if(t.length<p)return t;for(var i,n=Math.min(a.width,a.height)/2,r=g/(n*y),s=r*e,o=[],l=0,h=t;l<h.length;l++){var d=h[l];d.measure>=s&&(d.strokeWidth=i===d.color?1:0,i=d.color,o.push(d))}return o},i.getDefaultLabelSettings=function(t){return{show:!0,position:0,displayUnits:0,precision:e.dataLabelUtils.defaultLabelPrecision,fontProperties:e.LabelUtils.defaultFontProperties,enableBackground:!0,backgroundColor:e.ColorHelper.getThemeColor(t,e.LabelUtils.DefaultLabelBackgroundColorName),backgroundTransparency:.5}},i.OuterRadiusRatio=.8,i.DefaultDonutInnerRadiusRatio=.48,i.InteractiveLegendContainerHeight=70,i.EffectiveZeroValue=1e-9,i.PolylineOpacity=.5,i}();e.DonutChart=b;var m,L=function(){function t(t,e,a,i){this.maxLegendItemWidth=15,this.legendContainerParent=e,this.donutChart=t,this.visualInitOptions=i,this.legendItemsPositions=[]}return t.prototype.drawLegend=function(a){var i=this;this.data=a,this.currentNumberOfLegendItems=a.length,this.currentIndex=0,this.leftMostIndex=0,this.rightMostIndex=a.length-1,this.legendContainerParent.select(t.LegendContainerSelector).empty()&&(this.legendContainer=this.legendContainerParent.append("div").classed(t.LegendContainerClassName,!0));var n=this.legendContainer.selectAll(t.LegendItemSelector).data(a),r=this.legendContainerWidth=this.legendContainer.node().getBoundingClientRect().width,s=r/2-.4*r/2+t.ItemMargin,o=s;this.currentXOffset=s;var l=function(a,n){a.attr("data-legend-index",n.index).css({position:"absolute",left:o});var r=e.valueFormatter.format(n.label),s=e.valueFormatter.format(n.originalMeasure,n.measureFormat),l=e.valueFormatter.format(n.percentage,"0.00 %;-0.00 %;0.00 %"),h=n.color,d=t.createBasicLegendItemSpan(t.LegendItemValueClassName,s,11),c=t.createBasicLegendItemSpan(t.LegendItemCategoryClassName,r,11),u=t.createBasicLegendItemSpan(t.LegendItemPercentageClassName,l,20),g=t.spanWidth(d),p=t.spanWidth(c),v=t.spanWidth(u),f=t.legendBoxSize(g,p,v);a.css("width",f),i.maxLegendItemWidth=Math.max(i.maxLegendItemWidth,f);var y=function(t){return f-t>0?(f-t)/2:0},b=y(g),m=y(p),L=y(v);t.createLegendItemSpan(c,m),t.createLegendItemSpan(d,b),t.createLegendItemSpan(u,L).css("color",h),a.append(c),a.append(u),a.append(d),i.legendItemsPositions.push({startX:o,boxWidth:f}),o+=f+t.ItemMargin};n.enter().insert("div").classed(t.LegendItemClassName,!0).each(function(t){l($(this),t)}),n.exit().remove(),this.assignInteractions()},t.prototype.updateLegend=function(t){var i=this,n=this.legendContainerWidth;this.currentIndex=t,this.updateLabelBlocks(t);var r=(this.legendItemsPositions[t].startX+this.legendItemsPositions[t].boxWidth/2-n/2)*-1;this.legendContainer.transition().styleTween("-webkit-transform",function(t,a,n){return d3.interpolate(e.SVGUtil.translateWithPixels(i.currentXOffset,0),e.SVGUtil.translateWithPixels(r,0))}).styleTween("transform",function(t,a,n){return d3.interpolate(e.SVGUtil.translateWithPixels(i.currentXOffset,0),e.SVGUtil.translateWithPixels(r,0))}).duration(a.animationDurationMs).ease(a.ease).each("end",function(){i.currentXOffset=r}),e.SVGUtil.flushAllD3TransitionsIfNeeded(this.visualInitOptions)},t.prototype.assignInteractions=function(){var t=this,e=0,a=function(){e=0},i=function(){if(e+=d3.event.dx,!(Math.abs(e)<t.maxLegendItemWidth)){var a=e<0;t.dragLegend(a),e=0}},n=d3.behavior.drag().origin(Object).on("drag",i).on("dragstart",a);this.legendContainer.style({"touch-action":"none",cursor:"pointer"}).call(n)},t.prototype.dragLegend=function(e){this.currentNumberOfLegendItems>t.MinimumItemsInLegendForCycled-1?this.currentIndex=this.getCyclingCurrentIndex(e):this.shouldChangeIndexInNonCycling(e)&&(e?this.currentIndex++:this.currentIndex--),this.donutChart.setInteractiveChosenSlice(this.currentIndex)},t.prototype.shouldChangeIndexInNonCycling=function(t){return!(0===this.currentIndex&&!t||this.currentIndex===this.currentNumberOfLegendItems-1&&t)},t.prototype.getCyclingCurrentIndex=function(t){var e=this.data.length,a=t?1:-1,i=(this.currentIndex+a)%(e||1);return i<0?i+e:i},t.prototype.updateLegendItemsBlocks=function(e,a){var i=$(this.legendContainer[0]);if(e){var n=i.find("[data-legend-index="+this.leftMostIndex+"]");n.remove().insertAfter(i.find("[data-legend-index="+this.rightMostIndex+"]"));var r=this.legendItemsPositions[this.rightMostIndex].startX+this.legendItemsPositions[this.rightMostIndex].boxWidth+t.ItemMargin;this.legendItemsPositions[this.leftMostIndex].startX=r,n.css("left",r),this.rightMostIndex=this.leftMostIndex,this.leftMostIndex=(this.leftMostIndex+1)%this.data.length}else{var s=i.find("[data-legend-index="+this.rightMostIndex+"]");
s.remove().insertBefore(i.find("[data-legend-index="+this.leftMostIndex+"]"));var r=this.legendItemsPositions[this.leftMostIndex].startX-this.legendItemsPositions[this.rightMostIndex].boxWidth-t.ItemMargin;this.legendItemsPositions[this.rightMostIndex].startX=r,s.css("left",r),this.leftMostIndex=this.rightMostIndex,this.rightMostIndex=this.rightMostIndex-1===-1?this.legendItemsPositions.length-1:this.rightMostIndex-1}a-1!==0&&this.updateLegendItemsBlocks(e,a-1)},t.prototype.updateLabelBlocks=function(e){this.currentNumberOfLegendItems>t.MinimumItemsInLegendForCycled?(this.rightMostIndex===e&&this.updateLegendItemsBlocks(!0,2),this.leftMostIndex===e&&this.updateLegendItemsBlocks(!1,2),(this.rightMostIndex===e+1||0===this.rightMostIndex&&e===this.currentNumberOfLegendItems-1)&&this.updateLegendItemsBlocks(!0,1),(this.leftMostIndex===e-1||this.leftMostIndex===this.currentNumberOfLegendItems-1&&0===e)&&this.updateLegendItemsBlocks(!1,1)):this.currentNumberOfLegendItems===t.MinimumItemsInLegendForCycled&&(this.rightMostIndex===e&&this.updateLegendItemsBlocks(!0,1),this.leftMostIndex===e&&this.updateLegendItemsBlocks(!1,1))},t.createBasicLegendItemSpan=function(t,e,a){return $("<span/>").addClass(t).css({"white-space":"nowrap","font-size":a+"px"}).text(e)},t.createLegendItemSpan=function(t,e){return t.css({overflow:"hidden","text-overflow":"ellipsis",display:"inline-block",width:"100%","margin-left":e}),t},t.legendBoxSize=function(e,a,i){var n=e>a?e:a;return n=n>i?n:i,n=n>t.MaxLegendItemBoxSize?t.MaxLegendItemBoxSize:n+2},t.spanWidth=function(t){return this.FakeElementSpan||(this.FakeElementSpan=$("<span>").hide().appendTo(document.body)),this.FakeElementSpan.empty(),this.FakeElementSpan.append(t),this.FakeElementSpan.width()},t.LegendContainerClassName="legend-container",t.LegendContainerSelector=".legend-container",t.LegendItemClassName="legend-item",t.LegendItemSelector=".legend-item",t.LegendItemCategoryClassName="category",t.LegendItemPercentageClassName="percentage",t.LegendItemValueClassName="value",t.MaxLegendItemBoxSize=160,t.ItemMargin=30,t.MinimumItemsInLegendForCycled=3,t}();!function(a){var i=function(){function a(i,n,r,s){void 0===s&&(s=!0);var o=this.reader=t.data.createDataViewCategoricalReaderAdvanced(i,{staticSeriesRole:"Y",colorOptions:{valueRole:"Y",visualStyle:n}}),l=o.data;this.dataView=i;var h=i.categorical;if(this.dataViewMetadata=i.metadata,this.tooltipsEnabled=s,this.maxValue=0,this.hasNegativeValues=!1,this.allValuesAreNegative=!1,this.style=n,h.categories&&h.categories.length>0){var d=h.categories[0];this.categoryValues=d.values,this.categoryFormatString=e.valueFormatter.getFormatString(d.source,e.donutChartProps.general.formatString)}this.isDynamicSeries=o.columns.hasDynamicSeries(),this.highlightsOverflow=!1,this.total=0,this.highlightTotal=0,this.dataPoints=[],this.dataLabelsSettings=null;var c=0;if(r&&(c=t.DataViewObjects.getValue(o.objects.getStaticObjects(),e.donutChartProps.slices.innerRadiusRatio),null==c?c=r?b.DefaultDonutInnerRadiusRatio:0:c/=100/b.OuterRadiusRatio),this.donutInnerRadiusRatio=c,l.hasValues("Y")){var u=this.seriesCount=l.getSeriesCount();this.hasHighlights=l.hasHighlights();var g=l.getCategoryCount()||1;this.allValuesAreNegative=void 0;for(var p=0;p<g;p++)for(var v=0;v<u;v++){var f=l.getValue("Y",p,v),y=void 0;this.hasHighlights&&(y=l.getHighlight("Y",p,v),null==y&&(y=0)),void 0===this.allValuesAreNegative?this.allValuesAreNegative=(!this.hasHighlights||y<=0)&&f<=0:this.allValuesAreNegative=this.allValuesAreNegative&&(!this.hasHighlights||y<=0)&&f<=0,this.hasNegativeValues||(this.hasNegativeValues=f<0||!!this.hasHighlights&&y<0)}this.allValuesAreNegative=!!this.allValuesAreNegative;for(var p=0;p<g;p++)for(var v=0;v<u;v++){var f=l.getValue("Y",p,v);if(f=a.normalizedValue(f,this.allValuesAreNegative),this.total+=f,this.hasHighlights){var y=l.getHighlight("Y",p,v);y=a.normalizedValue(y,this.allValuesAreNegative),this.highlightTotal+=y,!this.highlightsOverflow&&t.Double.greaterWithPrecision(y,f,t.Double.getPrecision(Math.min(y,f)))&&(this.highlightsOverflow=!0)}}}}return a.normalizedValue=function(t,e){return null==t||isNaN(t)?0:t===Number.POSITIVE_INFINITY?Number.MAX_VALUE:t===Number.NEGATIVE_INFINITY?-Number.MAX_VALUE:e?Math.abs(t):t<0?0:t},a.prototype.convert=function(){var t,i=this.reader,n=this.reader.data;t=0!==this.total?this.categoryValues?this.convertCategoricalWithSlicing():this.isDynamicSeries?this.convertSeries():this.convertMeasures():[],this.dataLabelsSettings=this.convertDataLabelSettings();var r=this.dataViewMetadata;if(r){var s=r.objects;s&&(this.legendObjectProperties=s.legend)}var o=_.isEmpty(this.dataView.categorical.categories)?null:this.dataView.categorical.categories[0];this.dataPoints=[];for(var l,h=e.donutChartProps.general.formatString,d=e.valueFormatter.getLocalizedString("Percentage"),c=0,u=t.length;c<u;c++){var g=t[c],p=g.measure,v=a.normalizedValue(g.measure,this.allValuesAreNegative),f=g.highlightMeasure,y=a.normalizedValue(g.highlightMeasure,this.allValuesAreNegative),m=this.total>0?v/this.total:0,L=void 0,S=void 0;v>this.maxValue&&(this.maxValue=v),y>this.maxValue&&(this.maxValue=y),this.hasHighlights&&(this.highlightsOverflow?(p=f,v=y,m=this.highlightTotal>0?y/this.highlightTotal:0,L=1):L=0!==v?y/v:0,L||(L=b.EffectiveZeroValue),S=m*L);var C=g.categoryLabel,P=this.dataView.categorical,w=void 0;w=null!=g.seriesIndex?g.seriesIndex:c;var D=i.columns.getValueMetadataColumn("Y",w),x=this.hasHighlights&&this.highlightsOverflow?f:p,I=this.hasHighlights&&!this.highlightsOverflow?f:void 0,A=e.valueFormatter.getFormatString(D,h),R=e.valueFormatter.format(m,d),k=void 0;null!=x&&null!=R&&(k=e.valueFormatter.format(x,A)+" ("+R+")");var M=void 0;if(null!=I&&null!=S){var V=e.valueFormatter.format(S,d);M=e.valueFormatter.format(I,A)+" ("+V+")"}var F=void 0;this.tooltipsEnabled&&(F=[],o&&F.push({displayName:o.source.displayName,value:C}),this.isDynamicSeries&&(o&&o.source===P.values.source||F.push({displayName:P.values.source.displayName,value:g.label})),null!=k&&F.push({displayName:D.displayName,value:k}),null!=M&&F.push({displayName:e.ToolTipComponent.localizationOptions.highlightedValueDisplayName,value:M}),e.TooltipBuilder.addTooltipMeasures(i,F,this.categoryValues?g.categoryIndex:0,this.isDynamicSeries?g.seriesIndex:void 0,h));var T=this.style.isHighContrast||l===g.color&&m&&m>0?1:0;l=m&&m>0?g.color:l,this.dataPoints.push({identity:g.identity,measure:v,originalMeasure:p,measureFormat:g.measureFormat,percentage:m,index:g.index,label:g.label,highlightRatio:L,highlightValue:this.hasHighlights&&!this.highlightsOverflow?y:void 0,originalHighlightValue:this.hasHighlights&&!this.highlightsOverflow?f:void 0,highlightPercentage:this.hasHighlights&&!this.highlightsOverflow?S:void 0,selected:!1,tooltipInfo:F,color:g.color,strokeWidth:T,labelFormatString:D.format})}n.hasCategoryWithRole("Category")?this.legendData=e.Legend.buildCategoryLegendData({dataView:this.dataView,categoryRole:"Category",style:this.style,valueRole:"Y",showByDefault:!1}):this.legendData=e.Legend.buildSeriesLegendData({dataView:this.dataView,staticSeriesRole:"Y",style:this.style,showByDefault:!1})},a.prototype.convertCategoricalWithSlicing=function(){for(var t=this.reader,a=this.reader.data,i=this.dataView.categorical,n=e.donutChartProps.general.formatString,r=[],s=0,o=this.categoryValues.length;s<o;s++)for(var l=this.categoryValues[s],h=t.colors.createByCategory(s),d=e.valueFormatter.format(l,this.categoryFormatString),c=0;c<this.seriesCount;c++){var u=a.getValue("Y",s,c),g=this.hasHighlights?a.getHighlight("Y",s,c):void 0;if(null!=u||null!=g){var p=t.columns.getValueColumn("Y",c),v=d;(this.isDynamicSeries||a.getSeriesCount()>1)&&(v=e.converterHelper.getFormattedLegendLabel(p.source,i.values,n));var f=p.source.queryName,y=e.SelectionIdBuilder.builder().withCategory(i.categories[0],s).withSeries(i.values,this.isDynamicSeries?p:void 0).withMeasure(f).createSelectionId(),b={identity:y,measureFormat:e.valueFormatter.getFormatString(p.source,n,!0),measure:u,highlightMeasure:g,index:r.length,label:v,categoryLabel:d,color:h,categoryIndex:s,seriesIndex:c};r.push(b)}}return r},a.prototype.convertMeasures=function(){for(var t=this.reader,a=[],i=e.donutChartProps.general.formatString,n=0;n<this.seriesCount;n++){var r=t.data.getValue("Y",0,n),s=this.hasHighlights?t.data.getHighlight("Y",0,n):void 0,o=t.columns.getValueColumn("Y",n),l=e.valueFormatter.getFormatString(o.source,i,!0),h=o.source.displayName,d=e.SelectionId.createWithMeasure(o.source.queryName),c=t.colors.createBySeries(n),u={identity:d,measureFormat:l,measure:r,highlightMeasure:s,index:n,label:h,categoryLabel:h,color:c};a.push(u)}return a},a.prototype.convertSeries=function(){for(var t=this.reader,a=this.dataView.categorical,i=[],n=e.donutChartProps.general.formatString,r=0;r<this.seriesCount;r++){var s=t.data.getValue("Y",0,r),o=this.hasHighlights?t.data.getHighlight("Y",0,r):void 0,l=t.columns.getValueColumn("Y",r),h=e.valueFormatter.getFormatString(l.source,n,!0),d=e.converterHelper.getFormattedLegendLabel(l.source,a.values,n),c=(new e.SelectionIdBuilder).withSeries(a.values,l).withMeasure(l.source.queryName).createSelectionId(),u=t.colors.createBySeries(r),g={identity:c,measureFormat:h,measure:s,highlightMeasure:o,index:r,label:d,categoryLabel:d,color:u,seriesIndex:r};i.push(g)}return i},a.prototype.convertDataLabelSettings=function(){var a=this.dataViewMetadata,i=b.getDefaultDonutLabelSettings(this.style);if(a){var n=a.objects;if(n){var r=n.labels;r&&e.LabelUtils.updateLabelSettingsFromLabelsObject(r,i,void 0,this.style)}i.position=t.DataViewObjects.getValue(n,e.donutChartProps.labels.position,e.donutLabelPosition.outside),i.overflow=t.DataViewObjects.getValue(n,e.donutChartProps.labels.overflow,!0),i.enableBackgroundWithAuto=t.DataViewObjects.getValue(n,e.donutChartProps.labels.background,e.donutLabelBackground.auto)}return i},a}();a.DonutChartConverter=i}(m||(m={}))}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e;!function(t){var e=function(e){function a(t){return e.call(this,t)||this}return __extends(a,e),a.prototype.animate=function(t){var e={failed:!0,shapes:null,highlightShapes:null},a=t.viewModel,i=this.previousViewModel;if(a.highlightsOverflow||i&&i.highlightsOverflow)return this.previousViewModel=a,e;var n=i&&i.hasHighlights,r=a.hasHighlights;return i&&(r&&!n?e=this.animateNormalToHighlighted(t):r&&n?e=this.animateHighlightedToHighlighted(t):!r&&n&&(e=this.animateHighlightedToNormal(t))),this.previousViewModel=a,e},a.prototype.animateNormalToHighlighted=function(e){var a=this.animateDefaultShapes(e),i=e.graphicsContext.select(".slices").selectAll("path.slice-highlight").data(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio}),function(t){return t.data.identity.getKey()});i.enter().insert("path").classed("slice-highlight",!0).each(function(t){this._current=t}),t.DonutChart.isSingleColor(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio}));var n=e.interactivityService&&e.interactivityService.hasSelection();return i.style("fill",function(t){return t.data.color?t.data.color:e.colors.getNewColorScale().getColor(t.data.identity.getKey()).value}).style("fill-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!0,n,e.viewModel.hasHighlights)}).style("stroke",t.ColorHelper.getThemeColor(e.style,t.DefaultDonutStrokeColorName)).style("stroke-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!0,n,e.viewModel.hasHighlights)}).style("stroke-width",function(t){return t.data.strokeWidth}).attr(e.layout.shapeLayout.attrs).style(e.layout.shapeLayout.styles).transition().duration(this.animationDuration).attr(e.layout.highlightShapeLayout.attrs).style(e.layout.highlightShapeLayout.styles),i.exit().remove(),t.NewDataLabelUtils.drawLabelsAndBackgrounds({labelContext:e.labelGraphicsContext,backgroundContext:e.labelBackgroundContext,dataLabels:t.LabelUtils.downgradeToOldLabels(e.labels),hasTooltip:!0,numeric:!1,twoRows:!0}),t.LabelUtils.drawLabelLeaderLines(e.labelGraphicsContext,e.labels),{failed:!1,shapes:a,highlightShapes:i}},a.prototype.animateHighlightedToHighlighted=function(e){var a=this.animateDefaultShapes(e),i=this.animateDefaultHighlightShapes(e);return t.NewDataLabelUtils.drawLabelsAndBackgrounds({labelContext:e.labelGraphicsContext,backgroundContext:e.labelBackgroundContext,dataLabels:t.LabelUtils.downgradeToOldLabels(e.labels),hasTooltip:!0,numeric:!1,twoRows:!0}),t.LabelUtils.drawLabelLeaderLines(e.labelGraphicsContext,e.labels),{failed:!1,shapes:a,highlightShapes:i}},a.prototype.animateHighlightedToNormal=function(e){var a=e.interactivityService&&e.interactivityService.hasSelection(),i=this.animationDuration,n=e.graphicsContext.select(".slices").selectAll("path.slice").data(e.viewModel.dataPoints,function(t){return t.data.identity.getKey()});n.enter().insert("path").classed("slice",!0).each(function(t){this._current=t}),t.DonutChart.isSingleColor(e.viewModel.dataPoints),n.style("fill",function(t){return t.data.color?t.data.color:e.colors.getNewColorScale().getColor(t.data.identity.getKey()).value}).style("fill-opacity",function(e){return t.ColumnUtil.getFillOpacity(e.data.selected,!1,e.data.selected,!e.data.selected)}).style("stroke",t.ColorHelper.getThemeColor(e.style,t.DefaultDonutStrokeColorName)).style("stroke-opacity",function(e){return t.ColumnUtil.getFillOpacity(e.data.selected,!1,e.data.selected,!e.data.selected)}).style("stroke-width",function(t){return t.data.strokeWidth}).transition().duration(i).attr(e.layout.shapeLayout.attrs).style(e.layout.shapeLayout.styles).transition().duration(0).delay(i).style("fill-opacity",function(e){return t.ColumnUtil.getFillOpacity(e.data.selected,!1,a,!1)}).style("stroke-opacity",function(e){return t.ColumnUtil.getFillOpacity(e.data.selected,!1,a,!1)}),n.exit().remove();var r=e.graphicsContext.select(".slices").selectAll("path.slice-highlight").data(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio}),function(t){return t.data.identity.getKey()});return r.enter().insert("path").classed("slice-highlight",!0).each(function(t){this._current=t}),t.DonutChart.isSingleColor(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio})),r.exit().style("fill",function(t){return t.data.color?t.data.color:e.colors.getNewColorScale().getColor(t.data.identity.getKey()).value}).style("fill-opacity",function(e){return t.ColumnUtil.getFillOpacity(!1,!0,!1,!0)}).style("stroke",t.ColorHelper.getThemeColor(e.style,t.DefaultDonutStrokeColorName)).style("stroke-opacity",function(e){return t.ColumnUtil.getFillOpacity(!1,!0,!1,!0)}).style("stroke-width",function(t){return t.data.strokeWidth}).transition().duration(i).attr(a?e.layout.zeroShapeLayout.attrs:e.layout.shapeLayout.attrs).style(a?e.layout.zeroShapeLayout.styles:e.layout.shapeLayout.styles).remove(),t.NewDataLabelUtils.drawLabelsAndBackgrounds({labelContext:e.labelGraphicsContext,backgroundContext:e.labelBackgroundContext,dataLabels:t.LabelUtils.downgradeToOldLabels(e.labels),hasTooltip:!0,numeric:!1,twoRows:!0}),t.LabelUtils.drawLabelLeaderLines(e.labelGraphicsContext,e.labels),{failed:!1,shapes:n,highlightShapes:r}},a.prototype.animateDefaultShapes=function(e){var a=e.graphicsContext.select(".slices").selectAll("path.slice").data(e.viewModel.dataPoints,function(t){return t.data.identity.getKey()});return a.enter().insert("path").classed("slice",!0).each(function(t){this._current=t}),t.DonutChart.isSingleColor(e.viewModel.dataPoints),a.style("fill",function(t){return t.data.color?t.data.color:e.colors.getNewColorScale().getColor(t.data.identity.getKey()).value}).style("fill-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!1,!1,e.viewModel.hasHighlights)}).style("stroke",t.ColorHelper.getThemeColor(e.style,t.DefaultDonutStrokeColorName)).style("stroke-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!1,!1,e.viewModel.hasHighlights)}).style("stroke-width",function(t){return t.data.strokeWidth}).transition().duration(this.animationDuration).attr(e.layout.shapeLayout.attrs).style(e.layout.shapeLayout.styles),a.exit().remove(),a},a.prototype.animateDefaultHighlightShapes=function(e){var a=e.graphicsContext.select(".slices").selectAll("path.slice-highlight").data(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio}),function(t){return t.data.identity.getKey()});a.enter().insert("path").classed("slice-highlight",!0).each(function(t){this._current=t}),t.DonutChart.isSingleColor(e.viewModel.dataPoints.filter(function(t){return null!=t.data.highlightRatio}));var i=e.interactivityService&&e.interactivityService.hasSelection();return a.style("fill",function(t){return t.data.color?t.data.color:e.colors.getNewColorScale().getColor(t.data.identity.getKey()).value}).style("fill-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!0,i,e.viewModel.hasHighlights)}).style("stroke",t.ColorHelper.getThemeColor(e.style,t.DefaultDonutStrokeColorName)).style("stroke-opacity",function(a){return t.ColumnUtil.getFillOpacity(a.data.selected,!0,i,e.viewModel.hasHighlights)}).style("stroke-width",function(t){return t.data.strokeWidth}).transition().duration(this.animationDuration).attr(e.layout.highlightShapeLayout.attrs).style(e.layout.highlightShapeLayout.styles),a.exit().remove(),a},a}(t.BaseAnimator);t.WebDonutChartAnimator=e}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e;!function(t){var e=jsCommon.BrowserUtils,a=function(){function a(){}return a.prototype.bindEvents=function(a,i){var n=this.slices=a.slices,r=this.highlightSlices=a.highlightSlices,s=a.clearCatcher;this.hasHighlights=a.hasHighlights;var o=function(a){var n=t.InteractivityUtils.getPositionOfLastInputEvent();i.handleSelection(a.data,e.isCtrlOrMeta(d3.event),n)},l=function(a){if(!e.isCtrlOrMeta(d3.event)){t.EventBubblingUtil.markAsHandled(d3.event);var n=t.InteractivityUtils.getPositionOfLastInputEvent();i.handleContextMenu(a.data,n),d3.event.preventDefault()}};n.on("click",o),n.on("contextmenu",l),r&&(r.on("click",o),r.on("contextmenu",l)),s.on("click",function(){e.isCtrlOrMeta(d3.event)||i.handleClearSelection()})},a.prototype.renderSelection=function(e){var a=this.hasHighlights;this.slices.style("fill-opacity",function(i){return t.ColumnUtil.getFillOpacity(i.data.selected,!1,e,a)}).style("stroke-opacity",function(i){return t.ColumnUtil.getFillOpacity(i.data.selected,!1,e,a)}),this.highlightSlices&&this.highlightSlices.style("fill-opacity",function(i){return t.ColumnUtil.getFillOpacity(i.data.selected,!0,e,a)}).style("stroke-opacity",function(i){return t.ColumnUtil.getFillOpacity(i.data.selected,!0,e,a)})},a}();t.DonutChartWebBehavior=a}(e=t.visuals||(t.visuals={}))}(powerbi||(powerbi={}));var powerbi;!function(t){var e=t.visuals.donutLabelBackground,a=t.visuals.donutLabelPosition,i=t.visuals.DonutLabelUtils,n=jsCommon.EnumExtensions,r=t.visuals.FontProperties,s=t.visuals.labelStyle,o=t.visuals.LabelUtils,l=s.labelStyleFlagEnum,h=[s.categoryAndDataAndPercent,s.categoryAndData,s.categoryAndPercent,s.dataAndPercent],d="",c=[0,1,2,3,4],u=function(){function u(e){this.donutChartProperties=e,this.center={x:e.viewport.width/2,y:e.viewport.height/2},this.labelRadius=this.donutChartProperties.labelRadius;var a=r.toTextProperties(e.dataLabelsSettings.fontProperties);this.additionalParenthesesWidth=t.TextMeasurementService.measureSvgTextWidth(a,"()"),this.additionalSpaceWidth=t.TextMeasurementService.measureSvgTextWidth(a," "),this.ellipsisWidth=t.TextMeasurementService.measureSvgTextWidth(a,d)}return u.prototype.layout=function(e,a){for(var i=[],n=0,r=e;n<r.length;n++){var s=r[n];i.push({labelDataPoint:s,hasBeenRendered:!1,labelSize:s.textSize})}for(var o=[],l=[],h=this.donutChartProperties.viewport,d={labelDataPoints:i,maxNumberOfLabels:e.length},c=new t.LabelArrangeGrid([d],h),u=i.length-1;u>=0;u--){if(i[u].labelDataPoint.isPreferred){l=i.splice(u,1).concat(l)}}if(l.length>0&&(o=this.positionLabels(l,c,a)),e.length>0){var g=this.positionLabels(i,c,a);o=o.concat(g)}return _.filter(o,function(t){return t.isVisible})},u.prototype.positionLabels=function(t,i,n){var r=this,s=null==n.position?a.outside:n.position,o=[],l=!1,d=function(e){for(var a=0,n=t;a<n.length;a++){var r=n[a];if(!r.hasBeenRendered){var s=e(r,i);if(s){var h=s.label;if(h){s.overflows&&(l=!0),r.hasBeenRendered=!0,o.push(h)}}}}},c=function(){d(function(t,e){return{label:r.tryOutsidePositionForDonut(t,e,n),overflows:!0}})},u=function(){d(function(t,e){if(_.includes(h,r.donutChartProperties.dataLabelsSettings.labelStyle)){var a=r.splitDonutDataPoint(t,r.donutChartProperties.dataLabelsSettings.labelStyle);return r.tryInsidePositionForDonut(a,r.donutChartProperties,e,n)}return r.tryInsidePositionForDonut(t,r.donutChartProperties,e,n)})};switch(s){case a.outside:c();break;case a.inside:u();break;case a.preferOutside:c(),u();break;case a.preferInside:u(),c()}if(l&&n.enableBackgroundWithAuto===e.auto)for(var g=0,p=o;g<p.length;g++){var v=p[g];v.outside||(v.hasBackground=!0)}return o},u.prototype.tryOutsidePositionForDonut=function(t,e,a){var i=t.labelDataPoint,n=i.parentShape;if(!_.isEmpty(n.validPositions)&&0!==n.validPositions[0]){var r=n.validPositions[0],s=this.tryAllOutsidePositions(t,e,r);if(s&&0===s.score)return this.buildLabel(s,e,!0,a);if(_.includes(h,this.donutChartProperties.dataLabelsSettings.labelStyle)){var o=this.splitDonutDataPoint(t,this.donutChartProperties.dataLabelsSettings.labelStyle),l=this.tryAllOutsidePositions(o,e,r);if(l&&(!s||l.score<s.score)){return this.buildLabel(l,e,!0,a)}}return s?this.buildLabel(s,e,!0,a):void 0}},u.prototype.tryInsidePositionForDonut=function(t,e,a,i){var n=this.tryAllInsidePositions(t,e,a,i.overflow);if(n)return{label:this.buildLabel(n,a,!1,i),overflows:n.overflows}},u.prototype.generateCandidate=function(t,e,a){var n=t.labelDataPoint,r=u.generateCandidateAngleForPosition(n.donutArcDescriptor,e),s=this.getPointPositionForAngle(r),o=s.point,l=this.score(n,o),h=i.getLabelLeaderLineForDonutChart(n.donutArcDescriptor,this.donutChartProperties,o,r),d=i.getLabelLeaderLinesSizeForDonutChart(h),c=_.clone(n);return c.parentShape=s,c.leaderLinePoints=h,c.linesSize=d,{point:s,score:l,labelRects:u.tryPositionPoint(a,s.validPositions[0],c,this.center,this.donutChartProperties.viewport),donutLabelDataPointLayoutInfo:{labelDataPoint:c,hasBeenRendered:t.hasBeenRendered,labelSize:t.labelSize},renderLeaderLines:!0,overflows:!1}},u.prototype.tryAllOutsidePositions=function(t,e,a){var i=t.labelDataPoint,n=u.tryPositionPoint(e,a,i,this.center,this.donutChartProperties.viewport),r=i.parentShape,s={point:r,score:this.score(i,r.point),labelRects:n,donutLabelDataPointLayoutInfo:t,renderLeaderLines:!0,overflows:!1};if(n&&n.textRect&&0===s.score)return s;var o,l=[];n&&n.textRect?(l=u.getLabelPointPositions(i.parentShape,!0),o=s):l=u.getLabelPointPositions(i.parentShape,!1);for(var h=0,d=l;h<d.length;h++){var c=d[h],g=this.generateCandidate(t,c,e);if(g.labelRects&&g.labelRects.textRect&&(null==o||g.score<o.score)&&(o=g,0===o.score))return o}return o},u.prototype.tryAllInsidePositions=function(e,a,n,r){for(var s,o,l,h,d=e.labelDataPoint.angle,u=(a.innerRadius+a.outerRadius)/2,g=0,p=c;g<p.length;g++){var v=p[g],f=this.getInsidePosition(e,a,d,u,v),y=this.score(e.labelDataPoint,f),b={point:f,radius:0,validPositions:[256]},m=t.DataLabelPointPositioner.getLabelRect(e.labelDataPoint.textSize,b,256,0),L={left:m.left+this.center.x,top:m.top+this.center.y,width:m.width,height:m.height},S=!i.canLabelFit(e.labelDataPoint.donutArcDescriptor,a,m);!(null==l||y>l)||n.hasConflict(L)||!r&&S||(s=b,o=L,l=y,h=S)}if(s)return{point:s,score:0,labelRects:{textRect:o,diagonalLineRect:null,horizontalLineRect:null},donutLabelDataPointLayoutInfo:e,renderLeaderLines:!1,overflows:h}},u.prototype.getInsidePosition=function(t,e,a,n,r){var s,o,l=n,h=a;switch(r){case 0:break;case 1:s=e.outerRadius-e.innerRadius,l=n+.25*s;break;case 2:s=e.outerRadius-e.innerRadius,l=n-.25*s;break;case 3:o=t.labelDataPoint.donutArcDescriptor.endAngle-t.labelDataPoint.donutArcDescriptor.startAngle,h=a+.25*o;break;case 4:o=t.labelDataPoint.donutArcDescriptor.endAngle-t.labelDataPoint.donutArcDescriptor.startAngle,h=a-.25*o;break;default:debug.assertNever(r)}return i.getLabelPosition(h,l)},u.prototype.buildLabel=function(a,h,c,u){var g,p=a.labelRects.textRect,v=a.labelRects.horizontalLineRect,f=a.labelRects.diagonalLineRect,y=a.donutLabelDataPointLayoutInfo,b=y.labelDataPoint;null==b.categoryLabel&&null==b.dataLabel&&null==b.percentLabel||(g=!0),h.add(p),v&&h.add(v),f&&h.add(f);var m=p.top-this.center.y,L=p.left-this.center.x;c&&(L<0?L+=p.width/2:L-=p.width/2);var S;switch(a.point.validPositions[0]){case 8:S="start";break;case 4:S="end";break;case 256:S="middle"}var C,P,w,D,x={left:L,top:m,height:p.height,width:p.width},I=o.getLabelStyleFlagType(this.donutChartProperties.dataLabelsSettings.labelStyle),A=i.getSpaceAvailableForDonutLabels(b.parentShape.point.x,this.donutChartProperties.viewport),R=A,k=t.visuals.LabelUtils.getLabelTailoredText;if(I===s.labelStyleFlagEnum.categoryAndDataAndPercent?null==b.secondRowText?(A/=3,R=A):R/=2:I===l.categoryAndData?null==b.secondRowText&&(A/=2,R=A):I!==l.categoryAndPercent&&I!==l.dataAndPercent||null==b.secondRowText&&(A/=2,R=A),n.hasFlag(I,s.flagLabelStyleData)){var M=void 0;M=I!==s.labelStyleFlagEnum.categoryAndDataAndPercent&&I!==l.categoryAndData||null!=b.secondRowText?R:R-this.additionalSpaceWidth,M<this.ellipsisWidth&&(g=!1),C=k({label:b.dataLabel,maxWidth:M,fontProperties:b.fontProperties})}if(n.hasFlag(I,s.flagLabelStyleCategory)&&(A<this.ellipsisWidth&&(g=!1),P=k({label:b.categoryLabel,maxWidth:A,fontProperties:b.fontProperties})),n.hasFlag(I,s.flagLabelStylePercent)){var M=void 0;switch(I){case l.categoryAndDataAndPercent:M=R-this.additionalParenthesesWidth-this.additionalSpaceWidth;break;case l.dataAndPercent:M=null==b.secondRowText?R-this.additionalParenthesesWidth-this.additionalSpaceWidth:R-this.additionalParenthesesWidth;break;case l.categoryAndPercent:M=R-this.additionalSpaceWidth;break;case l.percent:M=R;break;default:M=R}M<this.ellipsisWidth&&(g=!1),w=k({label:b.percentLabel,maxWidth:M,fontProperties:b.fontProperties})}switch(C&&C!==d||P&&P!==d||w&&w!==d||(g=!1),I){case l.categoryAndDataAndPercent:w=w?" ("+w+")":null,null==b.secondRowText?(C=C?" "+C:null,D=P,C&&(D+=C),w&&(D+=w)):(D=w?C+w:C,b.secondRowText=P);break;case l.categoryAndData:null==b.secondRowText?(C=C?" "+C:null,D=C?P+C:P):(D=C,b.secondRowText=P);break;case l.categoryAndPercent:null==b.secondRowText?(w=w?" "+w:null,D=w?P+w:P):(D=w,b.secondRowText=P);break;case l.dataAndPercent:null==b.secondRowText?(w=w?" ("+w+")":null,D=w?C+w:C):(w=w?"("+w+")":null,D=w,b.secondRowText=C);break;case l.data:D=C;break;case l.percent:D=w;break;case l.category:D=P;break;default:D=P}var V;return V=I===l.categoryAndDataAndPercent&&null==b.secondRowText?A+R+R:I===l.categoryAndData||I===l.categoryAndPercent?A+R:I===l.dataAndPercent?R+R:A,b.textSize.width=Math.min(b.textSize.width,V),{boundingBox:x,text:D,tooltip:c?b.tooltip:null,isVisible:g,identity:b.identity,fontProperties:r.inherit(b.fontProperties,{color:c?b.outsideFill:b.insideFill}),selected:!1,textAnchor:S,leaderLinePoints:a.renderLeaderLines?b.leaderLinePoints:void 0,hasBackground:!c&&u.enableBackgroundWithAuto===e.on,secondRowText:b.secondRowText,backgroundColor:b.backgroundColor,backgroundTransparency:b.backgroundTransparency,outside:c}},u.tryPositionPoint=function(e,a,n,r,s){var l=n.parentShape,h=o.startingLabelOffset,d=_.clone(n.textSize);d.width=Math.min(d.width,i.getSpaceAvailableForDonutLabels(l.point.x,s));var c=t.DataLabelPointPositioner.getLabelRect(d,l,a,h),u={point:{x:n.leaderLinePoints[0][0],y:n.leaderLinePoints[0][1]<0?n.leaderLinePoints[1][1]:n.leaderLinePoints[0][1]},radius:0,validPositions:null},g=t.DataLabelPointPositioner.getLabelRect(n.linesSize[i.DiagonalLineIndex],u,a,h),p={point:{x:n.leaderLinePoints[1][0],y:n.leaderLinePoints[1][1]},radius:0,validPositions:null},v=t.DataLabelPointPositioner.getLabelRect(n.linesSize[i.HorizontalLineIndex],p,a,h);if(c&&g&&v){c.left+=r.x,c.top+=r.y;var f=r.x-c.width/2;return g.left+=f,g.top+=r.y,v.left+=f,v.top+=r.y,e.hasConflict(c)||e.hasConflict(g)||e.hasConflict(v)?void 0:{textRect:c,diagonalLineRect:g,horizontalLineRect:v}}},u.getLabelPointPositions=function(t,e){var a=t.validPositions[0];return e?t.point.y<0?8===a?[64]:[128]:8===a?[16]:[32]:4===a?[128,32]:[16,64]},u.prototype.splitDonutDataPoint=function(t,e){var a,i=t.labelDataPoint,n=i.categoryLabelSize?i.categoryLabelSize.width:0,r=i.dataLabelSize?i.dataLabelSize.width:0;a=i.percentLabelSize?e===s.dataAndPercent?i.percentLabelSize.width+this.additionalParenthesesWidth:e===s.categoryAndDataAndPercent?i.percentLabelSize.width+this.additionalParenthesesWidth+this.additionalSpaceWidth:i.percentLabelSize.width:0;var o=i.categoryLabelSize?i.categoryLabelSize.height:0,l=i.dataLabelSize?i.dataLabelSize.height:0,h=i.percentLabelSize?i.percentLabelSize.height:0,d={width:e===s.dataAndPercent?Math.max(r,a):Math.max(n,r+a),height:2*Math.max(o,Math.max(l,h))},c=_.clone(i);return c.textSize=d,c.secondRowText=e===s.dataAndPercent?i.dataLabel:i.categoryLabel,{labelDataPoint:c,hasBeenRendered:t.hasBeenRendered,labelSize:t.labelSize}},u.generateCandidateAngleForPosition=function(t,e){var a=t.startAngle+(t.endAngle-t.startAngle)/2;switch(e){case 64:case 32:return(t.startAngle+a-Math.PI)/2;case 128:case 16:return(a+t.endAngle-Math.PI)/2}},u.prototype.getPointPositionForAngle=function(t){var e=i.getXPositionForDonutLabel(Math.cos(t)*this.labelRadius);return{point:{x:e,y:Math.sin(t)*this.labelRadius},validPositions:[e<0?4:8],radius:0}},u.prototype.score=function(t,e){var a,n=i.getSpaceAvailableForDonutLabels(e.x,this.donutChartProperties.viewport),r=this.donutChartProperties.dataLabelsSettings.labelStyle,o=t.categoryLabelSize?t.categoryLabelSize.width:0,l=t.dataLabelSize?t.dataLabelSize.width:0,h=t.percentLabelSize?t.percentLabelSize.width:0;if(r===s.categoryAndDataAndPercent){if(null!=t.secondRowText){var d=Math.max(o-n,0),c=Math.max(Math.max(l,h+this.additionalParenthesesWidth+this.additionalSpaceWidth)-n/2,0);return Math.max(d,c)}a=Math.max(o,l+this.additionalSpaceWidth,h+this.additionalParenthesesWidth+this.additionalSpaceWidth),n/=3}else r===s.categoryAndData&&null==t.secondRowText?(a=Math.max(o,l+this.additionalSpaceWidth),n/=2):r===s.categoryAndPercent&&null==t.secondRowText?(a=Math.max(o,h+this.additionalSpaceWidth),n/=2):r===s.dataAndPercent?(a=null==t.secondRowText?Math.max(l,h+this.additionalParenthesesWidth+this.additionalSpaceWidth):Math.max(l,h+this.additionalParenthesesWidth),n/=2):a=t.textSize.width;return Math.max(a-n,0)},u}();t.DonutLabelLayout=u}(powerbi||(powerbi={}));